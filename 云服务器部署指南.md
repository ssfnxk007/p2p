# ☁️ 云服务器部署指南

## 📋 配置概览

**云服务器IP：** `42.51.41.138`  
**服务器端口：** `8000` (UDP)  
**组ID：** `测试组1`  
**组密钥：** `test123`

---

## ✅ 已更新的配置文件

### 客户端配置（本地运行）
- ✅ `TestDeploy/AccessClient/client_config.json` → 服务器: 42.51.41.138
- ✅ `TestDeploy/ServiceProvider/client_config.json` → 服务器: 42.51.41.138
- ✅ `client_config_访问端_DEBUG.json` → 服务器: 42.51.41.138
- ✅ `client_config_服务端_DEBUG.json` → 服务器: 42.51.41.138

### 服务器配置（云服务器运行）
- ✅ `TestDeploy/Server/server_config.json` → 监听端口: 8000

---

## 🚀 部署步骤

### 第一步：在云服务器上部署P2P服务器

#### 1. 配置云服务器防火墙
```bash
# 开放 UDP 8000 端口
# 阿里云/腾讯云：在安全组中添加规则
# 入站规则：
#   协议：UDP
#   端口：8000
#   源：0.0.0.0/0 (允许所有IP)
```

#### 2. 上传服务器文件
将以下文件上传到云服务器：
```
TestDeploy/Server/
├── P2PServer.dll
├── P2PServer.runtimeconfig.json
├── P2PServer.deps.json
└── server_config.json
```

#### 3. 在云服务器上安装 .NET 8 运行时
```bash
# Ubuntu/Debian
wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
sudo apt-get update
sudo apt-get install -y dotnet-runtime-8.0

# CentOS/RHEL
sudo dnf install dotnet-runtime-8.0
```

#### 4. 启动服务器
```bash
cd /path/to/Server
dotnet P2PServer.dll

# 或者使用 nohup 后台运行
nohup dotnet P2PServer.dll > server.log 2>&1 &
```

#### 5. 验证服务器运行
检查日志，应该看到：
```
✅ 服务器启动在端口 8000
⏰ 定时清理任务已启动（间隔10秒）
```

---

### 第二步：部署客户端（在不同的本地电脑）

#### 客户端A（访问端）
```
位置：你的电脑A
目录：TestDeploy/AccessClient/
配置：client_config.json (已配置为 42.51.41.138)
```

**启动命令：**
```bash
cd TestDeploy/AccessClient
dotnet P2PClient.dll
```

#### 客户端B（服务提供端）
```
位置：另一台电脑B
目录：TestDeploy/ServiceProvider/
配置：client_config.json (已配置为 42.51.41.138)
```

**启动命令：**
```bash
cd TestDeploy/ServiceProvider
dotnet P2PClient.dll
```

---

## 🔍 验证部署

### 1. 服务器日志
```
[INFO] 📨 收到 [xxx.xxx.xxx.xxx:xxxxx]: REGISTER:访问客户端:测试组1:test123
[INFO] [连接] 访问客户端 | 类型: 🔄 服务器中转 | 组:测试组1 @ xxx.xxx.xxx.xxx:xxxxx
[INFO] 📨 收到 [yyy.yyy.yyy.yyy:yyyyy]: REGISTER:服务提供端:测试组1:test123
[INFO] [连接] 服务提供端 | 类型: 🔄 服务器中转 | 组:测试组1 @ yyy.yyy.yyy.yyy:yyyyy
```

### 2. 客户端日志（访问端）
```
[INFO] ✅ 注册成功！服务器: 42.51.41.138, 组: 测试组1, 公网地址: xxx.xxx.xxx.xxx:xxxxx
[INFO] 📡 步骤1: 查询目标节点公网地址...
[INFO] ✅ 获取到目标节点地址: yyy.yyy.yyy.yyy:yyyyy
[INFO] 🎯 步骤2: 尝试 P2P 打洞...
```

**成功情况：**
```
[INFO] ✅ P2P 打洞成功！
[INFO] ✅ P2P 直连成功！耗时: X.X秒
[INFO] 💓 P2P保活已启动 (每30秒)
[INFO] [连接] 服务提供端 | 类型: ⚡ P2P直连
```

**降级情况：**
```
[WARN] ⚠️ P2P 打洞失败，耗时: 3.0秒，降级到服务器中转...
[INFO] 🔄 步骤3: 启用服务器中转模式...
[INFO] ✅ 服务器中转模式已启用！
[INFO] [连接] 服务提供端 | 类型: 🔄 服务器中转
```

---

## 📊 测试网络环境

### 测试场景1：同一公网出口的不同设备
```
路由器A (公网IP1)
  ├─ 电脑1 (访问端)
  └─ 电脑2 (服务端)
```
**预期：** P2P成功率 95%+

### 测试场景2：不同公网的家庭网络
```
路由器A (公网IP1) ← 电脑1 (访问端)
路由器B (公网IP2) ← 电脑2 (服务端)
```
**预期：** P2P成功率 70-90%（取决于NAT类型）

### 测试场景3：移动网络
```
4G/5G网络 ← 电脑1 (访问端)
WiFi网络 ← 电脑2 (服务端)
```
**预期：** P2P成功率 40-60%

---

## 🛠️ 故障排查

### 问题1: 客户端无法连接服务器

**症状：**
```
❌ 连接服务器 42.51.41.138 失败
```

**检查：**
1. ✅ 云服务器是否运行？`ps aux | grep P2PServer`
2. ✅ 防火墙是否开放UDP 8000？
3. ✅ 客户端网络是否正常？`ping 42.51.41.138`

### 问题2: P2P打洞失败

**症状：**
```
⚠️ P2P 打洞超时
```

**分析：**
- 查看是否收到 `PUNCH_START` 通知
- 查看是否收到对方的 `PUNCH` 包
- 如果都没有，说明NAT太严格，正常降级到中转

### 问题3: 连接后断开

**症状：**
```
连接建立后几分钟就断开
```

**检查：**
- 保活日志是否正常？应该每30秒一次
- NAT超时时间可能<30秒，需要缩短保活间隔

---

## 📈 性能监控

### 服务器监控
```bash
# 查看UDP端口连接数
netstat -an | grep :8000 | wc -l

# 查看服务器进程
ps aux | grep P2PServer

# 查看服务器日志
tail -f logs/server_DEBUG_*.log
```

### 客户端监控
```bash
# 查看客户端日志
tail -f logs/*_DEBUG_*.log

# 统计P2P成功率
grep "P2P 直连成功" logs/*.log | wc -l
grep "服务器中转模式已启用" logs/*.log | wc -l
```

---

## 🔐 安全建议

### 1. 修改默认组密钥
将 `test123` 改为强密钥：
```json
{
  "GroupKey": "你的强密码_至少16位"
}
```

### 2. 配置防火墙
```bash
# 只允许必要的端口
# UDP 8000 (P2P服务器)
# 其他端口全部关闭
```

### 3. 日志定期清理
```bash
# 设置日志轮转
# 避免日志文件过大
```

---

## 📞 技术支持

### 收集诊断信息

如果遇到问题，收集以下信息：

1. **服务器日志**
```bash
tail -100 logs/server_DEBUG_*.log > server_diagnostic.log
```

2. **客户端日志**
```bash
tail -100 logs/*客户端_DEBUG_*.log > client_diagnostic.log
```

3. **网络信息**
```bash
# 公网IP
curl ifconfig.me

# NAT类型（如果可以）
# 路由器配置中查看NAT模式
```

4. **测试结果统计**
```
测试次数: 10
P2P成功: 7次 (70%)
中转成功: 3次 (30%)
失败: 0次 (0%)
平均连接时间: 2.3秒
```

---

## ✅ 检查清单

部署前确认：
- [ ] 云服务器 .NET 8 运行时已安装
- [ ] 云服务器防火墙 UDP 8000 已开放
- [ ] 服务器配置文件正确
- [ ] 客户端配置文件指向正确IP (42.51.41.138)
- [ ] 两个客户端在不同网络环境

部署后验证：
- [ ] 服务器正常运行，日志正常
- [ ] 客户端能注册到服务器
- [ ] 客户端能查询到对方信息
- [ ] P2P打洞至少尝试过
- [ ] 降级到中转能正常工作

---

**准备好了！开始实战测试吧！** 🚀

**记得测试后分享结果数据！** 📊
