# P2P系统 - 部署说明

## 📁 部署文件夹结构

```
TestDeploy/
├── Server/                    # 云服务器部署（42.51.41.138）
│   ├── P2PServer.exe         # 服务器程序
│   ├── server_config.json    # 服务器配置
│   └── 启动服务器.bat         # 启动脚本
│
├── AccessClient/              # 访问客户端（本地机器）
│   ├── P2PClient.exe         # ✅ 已编译
│   ├── client_config.json    # ✅ 已配置（LocalPort: 1430）
│   └── 启动访问客户端.bat     # 启动脚本
│
└── ServiceProvider/           # 服务提供端（有SQL Server的机器）
    ├── P2PClient.exe         # ✅ 已编译
    ├── client_config.json    # ✅ 已配置
    └── 启动服务提供端.bat     # 启动脚本
```

## ✅ 编译状态

- ✅ AccessClient - 已编译到 `TestDeploy/AccessClient/`
- ✅ ServiceProvider - 已编译到 `TestDeploy/ServiceProvider/`
- ✅ 配置文件已更新（SQL隧道：1430 → 1433）

## 🚀 部署步骤

### 1. 云服务器（42.51.41.138）

```powershell
# 上传 TestDeploy/Server 整个文件夹
cd TestDeploy/Server
.\启动服务器.bat
```

**应该看到**：
```
🎮 P2P协调服务器已启动
📡 监听端口: 8000
🔐 组配置: 测试组1 (test123)
```

### 2. 服务提供端（有SQL Server的机器）

```powershell
# 复制 TestDeploy/ServiceProvider 文件夹
cd TestDeploy\ServiceProvider
.\启动服务提供端.bat
```

**应该看到**：
```
节点ID: 服务提供端
✅ 已注册到服务器
💓 心跳保持中...
```

### 3. 访问客户端（本地机器）

```powershell
# 复制 TestDeploy/AccessClient 文件夹
cd TestDeploy\AccessClient
.\启动访问客户端.bat
```

**应该看到**：
```
节点ID: 访问客户端
[端口转发] SQL隧道 已启动，监听端口 1430
🔗 自动连接到目标节点: 服务提供端
✅ P2P 直连成功！
⚡ 使用模式: P2P直连
```

## 🔧 SQL隧道配置详情

### AccessClient配置

```json
"PortForwards": [
  {
    "Name": "SQL隧道",
    "LocalPort": 1430,          // 本地监听端口
    "TargetPeerID": "服务提供端",
    "TargetPort": 1433,          // SQL Server端口
    "Protocol": "TCP"
  }
]
```

### 连接字符串

```csharp
// 在你的应用中使用
string connectionString = 
    "Server=localhost,1430;" +  // ← 注意是1430
    "Database=YourDatabase;" +
    "User Id=sa;" +
    "Password=YourPassword;";
```

## 📊 测试验证

### 1. 检查P2P连接

在AccessClient日志中应该看到：
```
✅ 获取到目标节点地址: x.x.x.x:port
🎯 开始P2P打洞...
✅ P2P 打洞成功！
💓 P2P保活已启动 (每30秒)
```

### 2. 测试端口转发

```powershell
# 在AccessClient机器上测试端口
netstat -ano | findstr :1430
# 应该看到 LISTENING 状态
```

### 3. 测试SQL连接

使用SQL管理工具或代码连接：
```
Server: localhost,1430
Database: master
User: sa
Password: [你的密码]
```

## 🗑️ 清理的文件

以下文件已移动到参考文件夹（不需要部署）：
- `P2PSQLAccessClient.cs` - 独立SQL客户端（已整合到P2PClient）
- `P2PSQLServiceProvider.cs` - 独立SQL服务端（已整合到P2PClient）
- `P2PSQLTunnel.cs` - SQL隧道实现（参考用）

**现在使用的是**：
- `P2PClient.exe` - 统一客户端程序
- `client_config.json` - JSON配置文件

## ⚙️ 配置修改

### 修改本地端口（例如改为1435）

编辑 `AccessClient/client_config.json`：
```json
"LocalPort": 1435,  // 改为1435
```

连接字符串改为：
```
Server=localhost,1435;...
```

### 添加更多转发规则

```json
"PortForwards": [
  {
    "Name": "SQL隧道",
    "LocalPort": 1430,
    "TargetPeerID": "服务提供端",
    "TargetPort": 1433,
    "Protocol": "TCP"
  },
  {
    "Name": "Web服务",
    "LocalPort": 8080,
    "TargetPeerID": "服务提供端",
    "TargetPort": 80,
    "Protocol": "TCP"
  }
]
```

## 🛠️ 故障排查

### 问题1：AccessClient无法连接到服务器
```
❌ 注册失败！请检查服务器配置
```

**解决**：
1. 检查云服务器是否运行
2. 检查防火墙是否开放UDP 8000
3. 检查Servers配置是否正确：`["42.51.41.138"]`

### 问题2：端口转发未启动
```
[端口转发] 启动失败
```

**解决**：
1. 检查1430端口是否被占用：`netstat -ano | findstr :1430`
2. 如果占用，修改LocalPort为其他值
3. 检查PortForwards配置是否正确

### 问题3：P2P连接失败
```
⚠️ P2P 打洞失败，降级到服务器中转...
```

**解决**：
- 中转模式也能正常工作，只是延迟稍高
- 查看日志确认是否已建立连接
- 测试SQL连接是否正常

### 问题4：SQL连接超时
```
Timeout expired
```

**解决**：
1. 检查P2P连接是否正常（查看日志）
2. 检查服务端SQL Server是否运行
3. 增加连接超时：`Connect Timeout=30;`

## 📝 日志位置

- **AccessClient日志**：`TestDeploy/AccessClient/logs/访问客户端_DEBUG_日期.log`
- **ServiceProvider日志**：`TestDeploy/ServiceProvider/logs/服务提供端_DEBUG_日期.log`
- **Server日志**：`TestDeploy/Server/logs/server_DEBUG_日期.log`

## 🎯 验证清单

部署前确认：
- [ ] 云服务器P2P服务正常运行
- [ ] 服务端SQL Server正常运行（127.0.0.1:1433）
- [ ] 三端GroupID和GroupKey一致
- [ ] AccessClient配置了正确的PortForwards
- [ ] 服务端先启动并注册成功
- [ ] 客户端启动后看到端口转发启动
- [ ] P2P连接建立（直连或中转）
- [ ] 本地1430端口可访问

## 📈 性能监控

### 查看连接状态
在客户端程序中输入命令：
```
> status
当前状态: 已连接
当前目标: 服务提供端
连接类型: ⚡ P2P直连  （或 🔄 服务器中转）
```

### 查看日志
```powershell
# Windows
type logs\访问客户端_DEBUG_*.log | findstr "P2P"

# 查看最新日志
Get-Content logs\访问客户端_DEBUG_*.log -Tail 50
```

## 🔐 安全建议

1. **修改默认GroupKey**
   ```json
   "GroupKey": "your_strong_password_here"
   ```

2. **使用专用SQL账户**
   ```sql
   CREATE LOGIN p2p_user WITH PASSWORD = 'StrongPass123!';
   GRANT SELECT, INSERT, UPDATE ON DATABASE::YourDB TO p2p_user;
   ```

3. **启用SQL加密**
   ```csharp
   "Server=localhost,1430;...;Encrypt=true;TrustServerCertificate=true;"
   ```

## 📞 技术支持

- **JSON配置说明**：`JSON配置说明_SQL隧道.md`
- **项目总结**：`项目总结与展望.md`
- **端口配置说明**：`端口配置说明.md`

---

**部署完成后**，你就可以在本地使用 `localhost:1430` 访问远程SQL Server了！

**最后更新**：2024-11-05
**版本**：1.0.0 - 通过JSON配置实现SQL隧道
